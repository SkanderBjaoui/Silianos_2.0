<nav
  [class]="'fixed w-full z-[9999] transition-all duration-500 ' + (shouldShowStickyBackground() ? 'bg-slate-900/80 backdrop-blur-xl shadow-lg border-b border-slate-800/60' : 'bg-transparent')"
  style="pointer-events: auto;"
>
  <div class="w-full relative" style="pointer-events: auto;">
    <div class="flex justify-between items-center h-20 px-2 md:px-4 relative overflow-hidden" style="pointer-events: auto; position: relative; z-index: 1; min-width: 0;">
      <!-- Logo -->
      <a routerLink="/" class="flex items-center space-x-2 md:space-x-3 group cursor-pointer flex-shrink-0 min-w-0" (click)="scrollToTop($event)">
        <img
          src="assets/@silianos_logo.png"
          alt="Silianos Voyage"
          [class]="'h-16 w-16 md:h-20 md:w-20 object-contain flex-shrink-0 transition-all duration-500 ease-out group-hover:scale-110 group-hover:rotate-6 group-hover:brightness-110 group-hover:drop-shadow-[0_0_15px_rgba(34,211,238,0.5)] ' + (scrolled ? 'brightness-100' : 'brightness-100')"
        />
        <span [class]="'text-lg md:text-2xl font-premium font-bold whitespace-nowrap transition-all duration-500 ease-out group-hover:scale-110 group-hover:drop-shadow-[0_0_10px_rgba(34,211,238,0.3)] ' + (shouldShowStickyBackground() ? 'text-slate-100 group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-cyan-400 group-hover:via-blue-400 group-hover:to-emerald-400 group-hover:bg-clip-text' : 'text-white group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-cyan-400 group-hover:via-blue-400 group-hover:to-emerald-400 group-hover:bg-clip-text')">
          Voyage
        </span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-1" style="pointer-events: auto; position: relative; z-index: 10000;">
        @for (item of navItems; track $index) {
          @if (isDropdown(item)) {
            <div 
              class="relative group dropdown-container"
              (mouseenter)="openDropdown(item.label)"
              (mouseleave)="closeDropdown(item.label)"
              style="z-index: 99999; position: relative;"
            >
              <a
                [routerLink]="item.href"
                class="dropdown-button inline-flex items-center"
                [attr.data-label]="item.label"
                [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 relative gap-1 ' + (shouldShowStickyBackground() ? 'text-slate-200 hover:text-cyan-300' : 'text-white hover:text-cyan-300')"
                (click)="handleDropdownClick(item, $event)"
              >
                {{ item.label }}
                <lucide-icon 
                  [name]="chevronDownIcon" 
                  [class]="'w-4 h-4 transition-transform duration-300 ' + (isDropdownOpen(item.label) ? 'rotate-180' : '')"
                ></lucide-icon>
                <div class="absolute bottom-0 left-0 h-1 w-0 group-hover:w-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full transition-all duration-300"></div>
              </a>
              
            </div>
          } @else if (isLink(item)) {
            @if (item.anchor) {
              <a
                [routerLink]="item.href"
                [fragment]="item.anchor.replace('#', '')"
                (click)="handleNavClick(item, $event)"
                [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 relative group ' + (shouldShowStickyBackground() ? 'text-slate-200 hover:text-cyan-300' : 'text-white hover:text-cyan-300')"
              >
                {{ item.label }}
                <div class="absolute bottom-0 left-0 h-1 w-0 group-hover:w-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full transition-all duration-300"></div>
              </a>
            } @else {
              <a
                [routerLink]="item.href"
                [class]="'px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 relative group ' + (shouldShowStickyBackground() ? 'text-slate-200 hover:text-cyan-300' : 'text-white hover:text-cyan-300')"
                (click)="handleRouteNav(item.href, $event)"
              >
                {{ item.label }}
                <div class="absolute bottom-0 left-0 h-1 w-0 group-hover:w-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full transition-all duration-300"></div>
              </a>
            }
          }
        }
        
        <!-- Currency Selector - Desktop -->
        <div class="ml-4 currency-menu-trigger">
          <div class="relative">
            <button
              type="button"
              class="currency-menu-trigger-button
                flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium border border-slate-700 bg-slate-900/70 hover:bg-slate-800 transition-colors"
              [class.text-slate-200]="shouldShowStickyBackground()"
              [class.text-white]="!shouldShowStickyBackground()"
              (click)="toggleCurrencyMenu($event)"
            >
              <span>{{ getSelectedCurrencyFlag() }}</span>
              <span>{{ selectedCurrency }}</span>
              <lucide-icon [name]="chevronDownIcon" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
        </div>

        <!-- Auth Buttons / User Menu - Right Side -->
        <div class="ml-2">
          @if (currentUser) {
            <div class="relative user-menu-container" style="z-index: 99999; position: relative;">
              <button
                (click)="toggleUserMenu($event)"
                class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:scale-105 relative group"
                [class]="(shouldShowStickyBackground() ? 'text-slate-200 hover:text-cyan-300' : 'text-white hover:text-cyan-300')"
              >
                <lucide-icon [name]="userIcon" class="w-4 h-4"></lucide-icon>
                {{ currentUser.name }}
                <lucide-icon
                  [name]="chevronDownIcon"
                  [class]="'w-4 h-4 transition-transform duration-300 ' + (userMenuOpen ? 'rotate-180' : '')"
                ></lucide-icon>
              </button>
              
              <!-- User menu trigger for positioning -->
              <div 
                #userMenuTrigger
                class="user-menu-trigger"
                style="display: none;"
              ></div>
            </div>
          } @else {
            <a
              routerLink="/login"
              class="px-4 py-2 rounded-lg text-sm font-medium bg-gradient-to-r from-cyan-500 to-emerald-500 text-white hover:shadow-lg hover:scale-105 transition-all duration-300"
            >
              Connexion
            </a>
          }
        </div>
      </div>

      <!-- Mobile Menu Button - Right Side -->
      <div class="md:hidden flex items-center ml-auto flex-shrink-0 mr-16">
        <button
          (click)="toggleMenu($event)"
          (mousedown)="toggleMenu($event)"
          (touchstart)="toggleMenu($event)"
          type="button"
          class="flex items-center justify-center p-2 rounded-lg border border-emerald-500/40 bg-gradient-to-r from-emerald-600/40 to-red-500/40 hover:from-emerald-500/60 hover:to-red-500/60 transition-colors shadow-lg shadow-emerald-500/20 mobile-menu-btn flex-shrink-0 mr-16"
          style="z-index: 99999 !important; pointer-events: auto !important;"
          [class.text-slate-100]="shouldShowStickyBackground()"
          [class.text-white]="!shouldShowStickyBackground()"
        >
          @if (isOpen) {
            <lucide-icon [name]="xIcon" class="w-6 h-6 pointer-events-none"></lucide-icon>
          } @else {
            <lucide-icon [name]="menuIcon" class="w-6 h-6 pointer-events-none"></lucide-icon>
          }
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Dropdowns rendered outside nav to escape stacking context - Desktop only -->
@for (item of navItems; track $index) {
  @if (isDropdown(item) && isDropdownOpen(item.label)) {
    <div 
      class="hidden md:block fixed w-56 pt-2 z-[10000]"
      (mouseenter)="openDropdown(item.label)"
      (mouseleave)="closeDropdown(item.label)"
      [style.top.px]="getDropdownPosition(item.label)?.top"
      [style.left.px]="getDropdownPosition(item.label)?.left"
      style="z-index: 10000 !important;"
    >
      <div class="bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-800 overflow-hidden animate-slide-down">
        <div class="py-2">
          @for (link of item.links; track link.label) {
            <a
              [routerLink]="link.href"
              [fragment]="link.anchor ? link.anchor.replace('#', '') : undefined"
              (click)="handleNavClick(link, $event)"
              class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
            >
              {{ link.label }}
            </a>
          }
        </div>
      </div>
    </div>
  }
}

@if (currentUser && userMenuOpen) {
  <div 
    class="hidden md:block fixed w-48 bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-800 overflow-hidden animate-slide-down z-[10000] mt-2"
    (mouseenter)="userMenuOpen = true"
    (mouseleave)="userMenuOpen = false"
    [style.top.px]="getUserMenuPosition()?.top"
    [style.right.px]="getUserMenuPosition()?.right"
    style="z-index: 10000 !important;"
  >
    <a
      routerLink="/dashboard"
      (click)="userMenuOpen = false"
      class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
    >
      Mon Tableau de Bord
    </a>
    <button
      (click)="logout()"
      class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800 hover:text-red-400 transition-colors flex items-center gap-2"
    >
      <lucide-icon [name]="logoutIcon" class="w-4 h-4"></lucide-icon>
      Déconnexion
    </button>
  </div>
}

<!-- Desktop Currency Dropdown -->
@if (currencyMenuOpen) {
  <div
    class="hidden md:block fixed w-56 bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-800 overflow-hidden animate-slide-down z-[10000]"
    [style.top.px]="getCurrencyMenuPosition()?.top"
    [style.right.px]="getCurrencyMenuPosition()?.right"
  >
    <div class="px-4 py-3 border-b border-slate-800">
      <p class="text-[11px] uppercase tracking-wide text-slate-500">Devise préférée</p>
    </div>
    <div class="py-2 max-h-64 overflow-y-auto">
      @for (currency of currencyOptions; track currency.code) {
        <button
          type="button"
          (click)="changeCurrency(currency)"
          [disabled]="currencyUpdateLoading"
          class="w-full flex items-center justify-between px-4 py-2 text-sm transition-colors"
          [class.bg-slate-800]="isSelectedCurrency(currency)"
          [class.text-cyan-300]="isSelectedCurrency(currency)"
          [class.text-slate-300]="!isSelectedCurrency(currency)"
        >
          <span class="flex items-center gap-2">
            <span class="text-lg leading-none">{{ currency.flag }}</span>
            {{ currency.code }}
          </span>
          @if (isSelectedCurrency(currency)) {
            <span class="text-[11px] uppercase tracking-wide text-emerald-300">sélectionnée</span>
          }
        </button>
      }
      @if (currencyUpdateLoading) {
        <p class="px-4 pt-1 text-[11px] text-emerald-300">Mise à jour...</p>
      }
    </div>
  </div>
}

<!-- Mobile Menu Modal - Outside nav to avoid stacking context issues -->
@if (isOpen) {
  <div class="md:hidden fixed inset-0 z-[9999]" style="z-index: 9999 !important;">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/70 backdrop-blur-md" (click)="toggleMenu()" style="z-index: 1;"></div>
    
    <!-- Modal Content -->
    <div class="relative z-10 h-full bg-slate-900/95 backdrop-blur-xl overflow-y-auto animate-slide-down" style="z-index: 2;">
      <!-- Modal Header with Close Button -->
      <div class="sticky top-0 bg-slate-900/95 backdrop-blur-xl border-b border-slate-800/60 px-4 py-4 flex items-center justify-between z-10">
        <h2 class="text-xl font-bold text-white">Menu</h2>
        <button
          (click)="toggleMenu()"
          class="p-2 rounded-lg text-white hover:bg-slate-800 transition-colors"
          aria-label="Fermer le menu"
        >
          <lucide-icon [name]="xIcon" class="w-6 h-6"></lucide-icon>
        </button>
      </div>
      
      <!-- Menu Content -->
      <div class="px-4 py-6 space-y-2">
        <!-- Auth Buttons / User Menu (Mobile) -->
        @if (currentUser) {
            <div class="border-b border-slate-800 pb-4 mb-4">
            <p class="text-slate-400 text-sm mb-2">Connecté en tant que</p>
            <p class="text-white font-semibold mb-3">{{ currentUser.name }}</p>
              <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <p class="text-[11px] uppercase tracking-wide text-slate-500">Devise préférée</p>
                <button (click)="toggleMobileCurrency($event)" class="px-2 py-1 rounded-md text-slate-300 hover:text-cyan-300">
                  <!-- Semantics swapped: when mobileCurrencyOpen is TRUE we now show the compact grid (collapsed), when FALSE we show the expanded/search view. Adjust rotation accordingly. -->
                  <lucide-icon [name]="chevronDownIcon" [class]="'w-4 h-4 transition-transform duration-200 ' + (mobileCurrencyOpen ? 'rotate-180' : '')"></lucide-icon>
                </button>
              </div>
              @if (mobileCurrencyOpen) {
                <!-- COMPACT GRID VIEW (now the 'collapsed' state) -->
                <div class="grid grid-cols-2 gap-2">
                  @for (currency of currencyOptions; track currency.code) {
                    <button
                      type="button"
                      (click)="changeCurrency(currency)"
                      [disabled]="currencyUpdateLoading"
                      class="flex items-center gap-1 px-3 py-2 rounded-lg text-sm border border-slate-800"
                      [class.bg-slate-800]="isSelectedCurrency(currency)"
                      [class.text-cyan-300]="isSelectedCurrency(currency)"
                      [class.text-slate-300]="!isSelectedCurrency(currency)"
                    >
                      <span>{{ currency.flag }}</span>
                      <span>{{ currency.code }}</span>
                    </button>
                  }
                </div>
              } @else {
                <!-- EXPANDED/SEARCH VIEW (now shown when mobileCurrencyOpen is FALSE) -->
                <div class="mb-2">
                  <input
                    type="text"
                    [(ngModel)]="mobileCurrencySearch"
                    class="mobile-currency-search w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-800 text-white placeholder-slate-500 focus:outline-none"
                    placeholder="Rechercher une devise..."
                    (click)="$event.stopPropagation()"
                  />
                </div>
                <div class="max-h-48 overflow-y-auto space-y-2">
                  @for (currency of filteredMobileCurrencies; track currency.code) {
                    <button
                      type="button"
                      (click)="changeCurrency(currency)"
                      [disabled]="currencyUpdateLoading"
                      class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors"
                      [class.bg-slate-800]="isSelectedCurrency(currency)"
                      [class.text-cyan-300]="isSelectedCurrency(currency)"
                      [class.text-slate-300]="!isSelectedCurrency(currency)"
                    >
                      <span class="flex items-center gap-2">
                        <span class="text-lg leading-none">{{ currency.flag }}</span>
                        <span>{{ currency.code }}</span>
                      </span>
                      @if (isSelectedCurrency(currency)) {
                        <span class="text-[11px] uppercase tracking-wide text-emerald-300">sélectionnée</span>
                      }
                    </button>
                  }
                </div>
              }

              @if (currencyUpdateLoading) {
                <p class="text-[11px] text-emerald-300 mt-2">Mise à jour...</p>
              }
            </div>
            
            <!-- Dashboard Menu with Dropdown -->
            <div>
              <div class="flex items-center">
                <a
                  routerLink="/dashboard"
                  (click)="isOpen = false"
                  class="flex-1 px-4 py-2 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all font-medium"
                >
                  Mon Tableau de Bord
                </a>
                <button
                  (click)="toggleDashboardMenu($event)"
                  class="px-2 py-2 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all"
                >
                  <lucide-icon 
                    [name]="chevronDownIcon" 
                    [class]="'w-4 h-4 transition-transform duration-300 ' + (dashboardMenuOpen ? 'rotate-180' : '')"
                  ></lucide-icon>
                </button>
              </div>
              
              @if (dashboardMenuOpen) {
                <div class="pl-4 pr-2 py-2 space-y-1">
                  <a
                    routerLink="/dashboard"
                    [fragment]="'overview'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="layoutIcon" class="w-4 h-4"></lucide-icon>
                    Vue d'ensemble
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'reservations'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="calendarIcon" class="w-4 h-4"></lucide-icon>
                    Mes Réservations
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'payments'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="creditCardIcon" class="w-4 h-4"></lucide-icon>
                    Paiements
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'profile'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="userIcon" class="w-4 h-4"></lucide-icon>
                    Mon Profil
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'favorites'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="heartIcon" class="w-4 h-4"></lucide-icon>
                    Favoris
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'notifications'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="bellIcon" class="w-4 h-4"></lucide-icon>
                    Notifications
                  </a>
                  <a
                    routerLink="/dashboard"
                    [fragment]="'support'"
                    (click)="isOpen = false"
                    class="flex items-center gap-2 block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                  >
                    <lucide-icon [name]="helpCircleIcon" class="w-4 h-4"></lucide-icon>
                    Support
                  </a>
                </div>
              }
            </div>
            
            <button
              (click)="logout(); isOpen = false"
              class="w-full text-left px-4 py-2 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-red-400 transition-all font-medium flex items-center gap-2 mt-2"
            >
              <lucide-icon [name]="logoutIcon" class="w-4 h-4"></lucide-icon>
              Déconnexion
            </button>
          </div>
        } @else {
            <div class="border-b border-slate-800 pb-4 mb-4 space-y-2">
            <a
              routerLink="/login"
              (click)="isOpen = false"
              class="block px-4 py-3 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all font-medium"
            >
              Connexion
            </a>
            <a
              routerLink="/signup"
              (click)="isOpen = false"
              class="block px-4 py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-emerald-500 text-white hover:shadow-lg transition-all font-medium text-center"
            >
              Inscription
            </a>
          </div>
        }
        @for (item of navItems; track $index) {
          @if (isDropdown(item)) {
            <div>
              <div class="flex items-center">
                <a
                  [routerLink]="item.href"
                  (click)="handleDropdownClick(item, $event)"
                  class="flex-1 px-4 py-3 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all font-medium"
                >
                  {{ item.label }}
                </a>
                <button
                  (click)="toggleDropdown(item.label, $event)"
                  class="px-2 py-3 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all"
                >
                  <lucide-icon 
                    [name]="chevronDownIcon" 
                    [class]="'w-4 h-4 transition-transform duration-300 ' + (isDropdownOpen(item.label) ? 'rotate-180' : '')"
                  ></lucide-icon>
                </button>
              </div>
              
              @if (isDropdownOpen(item.label)) {
                <div class="pl-4 pr-2 py-2 space-y-1">
                  @for (link of item.links; track link.label) {
                    <a
                      [routerLink]="link.href"
                      [fragment]="link.anchor ? link.anchor.replace('#', '') : undefined"
                      (click)="handleNavClick(link, $event)"
                      class="block px-4 py-2 rounded-lg text-sm text-slate-300 hover:bg-slate-800 hover:text-cyan-300 transition-colors"
                    >
                      {{ link.label }}
                    </a>
                  }
                </div>
              }
            </div>
          } @else if (isLink(item)) {
            @if (item.anchor) {
              <a
                [routerLink]="item.href"
                [fragment]="item.anchor.replace('#', '')"
                (click)="handleNavClick(item, $event)"
                class="block px-4 py-3 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all font-medium"
              >
                {{ item.label }}
              </a>
            } @else {
              <a
                [routerLink]="item.href"
                (click)="handleRouteNav(item.href, $event)"
                class="block px-4 py-3 rounded-lg text-slate-200 hover:bg-gradient-to-r hover:from-slate-800 hover:to-slate-700 hover:text-cyan-300 transition-all font-medium"
              >
                {{ item.label }}
              </a>
            }
          }
        }
      </div>
    </div>
  </div>
}
